<!DOCTYPE html>
<html>
<head>
<title></title>
</head>
<body>
<input value="I am happy!">
<button>Translate</button>
<blockquote></blockquote>
<script src="jspos/lexer.js"></script>
<script src="jspos/lexicon.js_"></script>
<script src="jspos/POSTagger.js"></script>
<script>
// Load synchronously for the sake of simplicity.
function require(url) {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', url, false);
  //xhr.responseType = 'json';
  xhr.overrideMimeType && xhr.overrideMimeType('application/json');
  xhr.setRequestHeader('Accept', 'application/json, text/javascript, */*; q=0.01');
  xhr.send();
  return JSON.parse(xhr.response);
}
</script>
<script>
'use strict';

var input = document.querySelector('input');
var output = document.querySelector('blockquote');
document.querySelector('button').addEventListener('click', function(e) {
  var translation = translate(input.value);
  output.textContent = translation;
}, false);

var enConverter = require('./pos-converter/en.json');
var jaConverter = require('./pos-converter/ja.json');
var jaDico = require('./dictionary/en.json');

function translate(source) {
  var pos = {
    Lexer: Lexer,
    Tagger: POSTagger
  };

  var jsposTable = {
    "JJR": "JJ",
    "JJS": "JJ",
    "NNPS": "NNP",
    "NNS": "NN",
    "RBR": "RB",
    "RBS": "RB",
    "VBD": "VB",
    "VBG": "VB",
    "VBN": "VB",
    "VBP": "VB",
    "VBZ": "VB",
    "WP$": "WP",
    "PRP$": "NN",
    "PRP": "NN"
  };

  // The POS common to both Chasen and js-pos.
  var posItems = ["UH", "RB", "JJ", "NN", "NNP", "CD", "SYM", ".", ":", "(", ")", "VB", "CC"];

  var sentence = source.toLowerCase();
  sentence = sentence.trim().replace(/(\.|\?|!|:)+$/, ''); // Remove the trailing punctuation.
  var words = new pos.Lexer().lex(sentence);
  words = new pos.Tagger().tag(words);
  var enPos = words.map(function(word) {
    if (jsposTable[word[1]]) {
      word[1] = jsposTable[word[1]];
    }
    return word[1];
  });
  var enWords = words.map(function(word) {
    return word[0];
  });
  enPos = enPos.join('|');

  var jaPos = enConverter[enPos];

  if (!jaPos) {
    console.log('No sentence with a similar POS structure found for: %s (%s)', source, enPos);
    return;
  }

  console.log(enPos);
  console.log(jaPos.ja);

  // Find the most frequent POS structure in JA associated with that in EN.
  var pos = '';
  var value = -1;
  for (var i in jaPos.ja) {
    if (jaPos.ja[i] > value) {
      pos = i;
      value = jaPos.ja[i];
    }
  }
  jaPos = pos;

  var commons = jaConverter[jaPos].commons;

  console.log(enPos);
  console.log(jaPos);

  enPos = enPos.split('|');
  jaPos = jaPos.split('|');

  var ja = jaPos.map(function(pos, index) {
    var translated = pos;
    posItems.some(function(posItem) {
      if (pos === posItem) {
        var wordIndex = enPos.indexOf(pos);
        if (wordIndex < 0) {
          return false;
        }

        var enWord = enWords[wordIndex];

        if (!jaDico[enWord]) {
          return false;
        }
        var jaWord = jaDico[enWord][pos];

        var value = -1;
        for (var i in jaWord) {
          if (jaWord[i] > value) {
            translated = i;
            value = jaWord[i];
          }
        }

        return true;
      }
      return false;
    });

    // Find the most frequent commons for this POS at this position.
    if (translated === pos) {
      var value = -1;
      for (var i in commons[index]) {
        if (commons[index][i] > value) {
          translated = i;
          value = commons[index][i];
        }
      }

    }

    return translated;
  });

  ja = ja.join('');
  return ja;
}
</script>
</body>
</html>
